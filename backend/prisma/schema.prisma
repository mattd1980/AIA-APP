// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InventoryStatus {
  draft
  processing
  completed
  error
}

enum ItemCategory {
  furniture
  electronics
  clothing
  appliances
  decor
  jewelry
  art
  collectibles
  sports_equipment
  other
}

enum ItemCondition {
  new
  excellent
  good
  fair
  poor
}

enum ReportType {
  pdf
  json
  csv
}

enum AnalysisStatus {
  idle
  processing
  completed
  error
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique @db.VarChar(255)
  name          String?     @db.VarChar(255)
  googleId      String?     @unique @db.VarChar(255)
  picture       String?     @db.VarChar(500)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  inventories   Inventory[]
  locations     Location[]
  
  @@index([email])
  @@index([googleId])
}

// Lieu (adresse ou domicile) : contient des pièces et des coffres
model Location {
  id          String   @id @default(uuid())
  userId      String
  name        String   @db.VarChar(255)
  address     String?  @db.VarChar(500)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rooms       Room[]
  safes       Safe[]

  @@index([userId])
}

// Pièce : appartient à un lieu, peut avoir plusieurs photos
model Room {
  id               String         @id @default(uuid())
  locationId       String
  name             String         @db.VarChar(255)
  analysisStatus   AnalysisStatus @default(idle)
  analysisMetadata Json           @default("{}")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  location   Location           @relation(fields: [locationId], references: [id], onDelete: Cascade)
  images     RoomImage[]
  items      RoomDetectedItem[]

  @@index([locationId])
}

// Coffre-fort : appartient à un lieu, peut avoir plusieurs photos
model Safe {
  id               String         @id @default(uuid())
  locationId       String
  name             String         @db.VarChar(255)
  analysisStatus   AnalysisStatus @default(idle)
  analysisMetadata Json           @default("{}")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  location   Location           @relation(fields: [locationId], references: [id], onDelete: Cascade)
  images     SafeImage[]
  items      SafeDetectedItem[]

  @@index([locationId])
}

// Photo d'une pièce
model RoomImage {
  id          String   @id @default(uuid())
  roomId      String
  imageData   Bytes
  imageType   String   @db.VarChar(50)
  fileName    String   @db.VarChar(255)
  fileSize    Int
  uploadOrder Int      @default(0)
  createdAt   DateTime @default(now())

  room   Room               @relation(fields: [roomId], references: [id], onDelete: Cascade)
  items  RoomDetectedItem[]

  @@index([roomId])
}

// Objet détecté par l'IA ou ajouté manuellement (roomImageId null = manuel)
model RoomDetectedItem {
  id                String        @id @default(uuid())
  roomId            String
  roomImageId       String?       // null = ajouté manuellement (suggestion assurance)
  category          ItemCategory
  itemName          String        @db.VarChar(255)
  brand             String?       @db.VarChar(100)
  model             String?       @db.VarChar(100)
  condition         ItemCondition
  estimatedAge      Int?
  notes             String?       @db.Text
  estimatedValue    Decimal       @default(0) @db.Decimal(10, 2)
  replacementValue  Decimal       @default(0) @db.Decimal(10, 2)
  aiAnalysis        Json          @default("{}")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  room      Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomImage RoomImage? @relation(fields: [roomImageId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([roomImageId])
}

// Photo d'un coffre
model SafeImage {
  id          String   @id @default(uuid())
  safeId      String
  imageData   Bytes
  imageType   String   @db.VarChar(50)
  fileName    String   @db.VarChar(255)
  fileSize    Int
  uploadOrder Int      @default(0)
  createdAt   DateTime @default(now())

  safe   Safe               @relation(fields: [safeId], references: [id], onDelete: Cascade)
  items  SafeDetectedItem[]

  @@index([safeId])
}

// Objet détecté par l'IA ou ajouté manuellement (safeImageId null = manuel)
model SafeDetectedItem {
  id                String        @id @default(uuid())
  safeId            String
  safeImageId       String?       // null = ajouté manuellement (suggestion assurance)
  category          ItemCategory
  itemName          String        @db.VarChar(255)
  brand             String?       @db.VarChar(100)
  model             String?       @db.VarChar(100)
  condition         ItemCondition
  estimatedAge      Int?
  notes             String?       @db.Text
  estimatedValue    Decimal       @default(0) @db.Decimal(10, 2)
  replacementValue  Decimal       @default(0) @db.Decimal(10, 2)
  aiAnalysis        Json          @default("{}")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  safe      Safe       @relation(fields: [safeId], references: [id], onDelete: Cascade)
  safeImage SafeImage? @relation(fields: [safeImageId], references: [id], onDelete: Cascade)

  @@index([safeId])
  @@index([safeImageId])
}

model Inventory {
  id                          String    @id @default(uuid())
  userId                      String
  name                        String?   @db.VarChar(255)
  status                      InventoryStatus @default(draft)
  totalEstimatedValue         Decimal   @default(0) @db.Decimal(10, 2)
  recommendedInsuranceAmount  Decimal   @default(0) @db.Decimal(10, 2)
  metadata                    Json      @default("{}")
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  
  user                        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items                       InventoryItem[]
  images                      InventoryImage[]
  reports                     Report[]
  
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([userId])
}

model InventoryItem {
  id                String        @id @default(uuid())
  inventoryId       String
  category          ItemCategory
  itemName          String        @db.VarChar(255)
  brand             String?       @db.VarChar(100)
  model             String?       @db.VarChar(100)
  condition         ItemCondition
  estimatedAge      Int?
  notes             String?       @db.Text
  estimatedValue    Decimal       @default(0) @db.Decimal(10, 2)
  replacementValue  Decimal       @default(0) @db.Decimal(10, 2)
  aiAnalysis        Json          @default("{}")
  priceData         Json          @default("{}")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  inventory         Inventory     @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  images            InventoryImage[]
  
  @@index([inventoryId])
  @@index([category])
}

model InventoryImage {
  id          String    @id @default(uuid())
  inventoryId String
  itemId      String?
  imageData   Bytes
  imageType   String    @db.VarChar(50)
  fileName    String    @db.VarChar(255)
  fileSize    Int
  uploadOrder Int       @default(0)
  createdAt   DateTime  @default(now())
  
  inventory   Inventory     @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  item        InventoryItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)
  
  @@index([inventoryId])
  @@index([itemId])
}

model Report {
  id          String     @id @default(uuid())
  inventoryId String
  reportType  ReportType @default(pdf)
  reportData  Bytes
  generatedAt DateTime   @default(now())
  
  inventory   Inventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  @@index([inventoryId])
}
