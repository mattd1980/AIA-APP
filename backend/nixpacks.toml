[variables]
NODE_VERSION = "20"

[phases.setup]
nixPkgs = ["nodejs"]

[phases.install]
cmds = ["cd backend && npm install"]

[phases.build]
cmds = [
  "echo '=== Build phase starting ===' && pwd",
  "cd backend && npm run build && cd ..",
  "cd frontend && npm ci && npm run build && cd ..",
  "echo '=== Verifying frontend build ===' && pwd",
  "ls -la frontend/dist/ 2>&1 | head -5 || echo 'Cannot list frontend/dist'",
  "test -f frontend/dist/index.html && echo '✅ frontend/dist/index.html exists' || echo '❌ frontend/dist/index.html missing'",
  "echo '=== Copying to backend/public ==='",
  "rm -rf backend/public && mkdir -p backend/public",
  "cp -r frontend/dist/. backend/public/ && echo 'Copy completed' || echo 'Copy failed'",
  "test -f backend/public/index.html && echo '✅ SUCCESS: Frontend in backend/public' || echo '❌ FAILED: index.html not in backend/public'",
  "ls -la backend/public/ 2>&1 | head -10",
  "echo '=== Build phase complete ==='"
]

[start]
cmd = "cd backend && npm run railway"
